<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Jobo AI Assistant</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="/static/css/fonts.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-primary, 'Inter', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif);
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            /* Prevent zoom on input focus on iOS */
            -webkit-text-size-adjust: 100%;
            /* Prevent horizontal scrolling */
            overflow-x: hidden;
        }

        .container {
            width: 90%;
            max-width: 800px;
            height: 90vh;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            backdrop-filter: blur(10px);
            /* Ensure container stays in view on mobile */
            position: relative;
        }

        /* Header styling */
        .header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            padding: 20px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-family: var(--font-accent, 'Space Grotesk', Arial, sans-serif);
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            letter-spacing: -0.03em;
        }

        .jobo-brand {
            font-family: var(--font-accent, 'Space Grotesk', Arial, sans-serif);
            font-weight: 700;
        }

        .header p {
            font-family: var(--font-primary, 'Inter', sans-serif);
            opacity: 0.9;
            font-size: 0.9rem;
            font-weight: 400;
        }

        .user-info {
            position: absolute;
            top: 20px;
            left: 50px;
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.8rem;
            display: none;
            color: white;
            backdrop-filter: blur(5px);
        }

        .status-indicator {
            position: absolute;
            top: 26px;
            left: 20px;
            width: 12px;
            height: 12px;
            background: #4ade80;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        /* Authentication forms styling */
        .auth-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 40px;
        }

        .auth-form {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        .auth-form h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #334155;
            font-family: var(--font-heading, 'Poppins', sans-serif);
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #475569;
            font-weight: 500;
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
        }

        .auth-button {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .auth-button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .switch-form {
            text-align: center;
            color: #64748b;
        }

        .switch-form a {
            color: #4facfe;
            text-decoration: none;
            font-weight: 500;
        }

        .switch-form a:hover {
            text-decoration: underline;
        }

        .error-message {
            background: #fee2e2;
            color: #dc2626;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 0.9rem;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* Chat interface styling (same as before) */
        .chat-container {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .message {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            max-width: 80%;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message.assistant {
            align-self: flex-start;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
            flex-shrink: 0;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .message.assistant .message-avatar {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .message-content {
            background: white;
            padding: 15px;
            border-radius: 18px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            font-family: var(--font-jobo, 'Space Grotesk', Arial, sans-serif);
            font-weight: 500;
            letter-spacing: -0.01em;
        }

        .chat-input-container {
            padding: 20px;
            background: white;
            border-top: 1px solid #e2e8f0;
            /* Ensure input container stays visible on mobile */
            position: sticky;
            bottom: 0;
            z-index: 100;
            /* Prevent container from disappearing behind mobile keyboard */
            min-height: 80px;
        }

        .chat-input-form {
            display: flex;
            gap: 10px;
            align-items: center;
            /* Ensure form elements stay aligned */
            width: 100%;
        }

        .chat-input {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 25px;
            font-size: 1rem;
            outline: none;
            transition: all 0.3s ease;
            /* Prevent input from disappearing on mobile */
            min-height: 50px;
            /* Prevent zoom on iOS */
            font-size: 16px;
            /* Ensure input stays visible */
            background: white;
            /* Prevent input from being cut off */
            box-sizing: border-box;
            /* Handle long text properly */
            word-wrap: break-word;
            resize: none;
        }

        .chat-input:focus {
            border-color: #4facfe;
            box-shadow: 0 0 0 3px rgba(79, 172, 254, 0.1);
            /* Ensure focus state is visible on mobile */
            position: relative;
            z-index: 101;
        }

        .send-button {
            width: 50px;
            height: 50px;
            border: none;
            border-radius: 50%;
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(79, 172, 254, 0.4);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .typing-indicator {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 18px;
            margin-left: 50px;
        }

        .typing-dots {
            display: flex;
            gap: 4px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite;
        }

        .typing-dot:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dot:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .logout-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .logout-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 768px) {
            body {
                /* Prevent body scroll when keyboard appears */
                position: fixed;
                width: 100%;
                height: 100%;
            }

            .container {
                width: 95%;
                height: 95vh;
                border-radius: 15px;
                /* Ensure container adapts to mobile keyboard */
                max-height: 100vh;
                /* Prevent container from being pushed off screen */
                position: relative;
            }

            .auth-form {
                padding: 30px;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .message {
                max-width: 90%;
            }

            .user-info {
                left: 40px;
                font-size: 0.7rem;
                padding: 4px 8px;
            }

            .logout-button {
                font-size: 0.7rem;
                padding: 6px 10px;
            }

            .status-indicator {
                top: 24px;
                left: 15px;
                width: 10px;
                height: 10px;
            }

            /* Mobile-specific chat input improvements */
            .chat-input-container {
                padding: 15px;
                /* Ensure input area is always visible */
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                background: white;
                border-top: 1px solid #e2e8f0;
                z-index: 1000;
                /* Account for mobile safe areas */
                padding-bottom: max(15px, env(safe-area-inset-bottom));
            }

            .chat-input {
                /* Larger touch target for mobile */
                min-height: 44px;
                padding: 12px 16px;
                /* Ensure text is readable on mobile */
                font-size: 16px;
                /* Prevent input zoom on iOS */
                -webkit-appearance: none;
                border-radius: 22px;
            }

            .send-button {
                /* Larger touch target for mobile */
                width: 44px;
                height: 44px;
                flex-shrink: 0;
            }

            .chat-messages {
                /* Account for fixed input container */
                padding-bottom: 100px;
                /* Ensure messages don't get cut off */
                margin-bottom: 0;
            }

            /* Handle mobile keyboard appearance */
            .chat-container {
                /* Ensure chat container fills available space */
                height: 100%;
                max-height: 100vh;
                overflow: hidden;
            }
        }

        /* Additional mobile landscape support */
        @media (max-width: 768px) and (orientation: landscape) {
            .container {
                height: 98vh;
            }
            
            .chat-input-container {
                padding: 10px 15px;
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            .chat-input {
                /* Prevent iOS zoom */
                font-size: 16px;
                /* Fix iOS input styling */
                -webkit-appearance: none;
                border-radius: 25px;
            }
        }

        /* Mobile keyboard open state */
        body.keyboard-open {
            height: 100vh;
            overflow: hidden;
        }

        body.keyboard-open .container {
            height: 100vh;
            max-height: 100vh;
        }

        body.keyboard-open .chat-messages {
            padding-bottom: 120px;
        }

        /* Ensure input is always visible and accessible */
        .chat-input:focus {
            /* Force input to stay visible on mobile */
            transform: translateZ(0);
            -webkit-transform: translateZ(0);
        }

        /* Handle large text in input */
        .chat-input {
            /* Allow input to expand slightly for long text */
            max-height: 120px;
            overflow-y: auto;
            /* Smooth scrolling for long text */
            scroll-behavior: smooth;
        }

        /* Enhanced features styles */
        .input-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .action-button {
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            color: #374151;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .action-button:hover {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(79, 172, 254, 0.3);
        }

        .action-button.active {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            color: white;
        }

        /* Modal styles for enhanced features */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #f1f5f9;
            padding-bottom: 15px;
        }

        .modal-header h3 {
            color: #1e293b;
            font-size: 1.5rem;
            font-weight: 600;
        }

        .close {
            color: #64748b;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .close:hover {
            color: #dc2626;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .feature-card {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 2px solid #e2e8f0;
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .feature-card:hover {
            border-color: #4facfe;
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(79, 172, 254, 0.2);
        }

        .feature-card i {
            font-size: 2rem;
            color: #4facfe;
            margin-bottom: 10px;
        }

        .feature-card h4 {
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .feature-card p {
            color: #64748b;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        /* Image preview styles */
        .image-preview {
            margin: 15px 0;
            text-align: center;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 200px;
            border-radius: 10px;
            border: 2px solid #e5e7eb;
        }

        .image-preview .remove-image {
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 5px 10px;
            margin-top: 10px;
            cursor: pointer;
            font-size: 12px;
        }

        /* Insights display */
        .insights-content {
            background: #f8fafc;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
        }

        .insight-section {
            margin-bottom: 20px;
        }

        .insight-section h4 {
            color: #1e293b;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .insight-item {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            border-left: 4px solid #4facfe;
        }

        .suggestion-item {
            background: #fef3c7;
            border-left-color: #f59e0b;
        }

        .engagement-score {
            text-align: center;
            font-size: 2rem;
            font-weight: bold;
            color: #4facfe;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="status-indicator"></div>
            <div class="user-info" id="user-info">
                <i class="fas fa-user"></i> <span id="current-username">guest</span>
            </div>
            <button class="logout-button" id="logout-button" style="display: none;">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
            <h1>
                <i class="fas fa-robot"></i>
                <span class="jobo-brand">Jobo</span> AI Assistant
            </h1>
            <p>Your personalized AI companion that learns and grows with you</p>
        </div>

        <!-- Authentication Container -->
        <div class="auth-container" id="auth-container">
            <!-- Login Form -->
            <div class="auth-form" id="login-form">
                <h2><i class="fas fa-sign-in-alt"></i> Welcome Back</h2>
                <div id="login-error" class="error-message" style="display: none;"></div>
                <form id="login-form-element">
                    <div class="form-group">
                        <label for="login-username">Username</label>
                        <input type="text" id="login-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="login-password">Password</label>
                        <input type="password" id="login-password" name="password" required>
                    </div>
                    <button type="submit" class="auth-button" id="login-button">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                </form>
                <div class="switch-form">
                    Don't have an account? <a href="#" id="show-register">Create one here</a>
                </div>
            </div>

            <!-- Register Form -->
            <div class="auth-form" id="register-form" style="display: none;">
                <h2><i class="fas fa-user-plus"></i> Join Jobo</h2>
                <div id="register-error" class="error-message" style="display: none;"></div>
                <form id="register-form-element">
                    <div class="form-group">
                        <label for="register-username">Username</label>
                        <input type="text" id="register-username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="register-email">Email (optional)</label>
                        <input type="email" id="register-email" name="email">
                    </div>
                    <div class="form-group">
                        <label for="register-password">Password</label>
                        <input type="password" id="register-password" name="password" required>
                    </div>
                    <div class="form-group">
                        <label for="register-display-name">Display Name (optional)</label>
                        <input type="text" id="register-display-name" name="display_name">
                    </div>
                    <button type="submit" class="auth-button" id="register-button">
                        <i class="fas fa-user-plus"></i> Create Account
                    </button>
                </form>
                <div class="switch-form">
                    Already have an account? <a href="#" id="show-login">Login here</a>
                </div>
            </div>
        </div>

        <!-- Chat Container -->
        <div class="chat-container" id="chat-container">
        <div class="chat-messages" id="chat-messages">
                <div class="welcome-message" id="welcome-message">
                    <h2>ðŸ‘‹ Welcome back to Jobo!</h2>
                    <p>I'm your personalized AI assistant. I remember our previous conversations and adapt to your communication style.</p>
                    <p>What would you like to talk about today?</p>
            </div>
        </div>

        <div class="typing-indicator" id="typing-indicator">
            <div class="message-avatar">
                <i class="fas fa-robot"></i>
            </div>
            <div>
                Jobo is thinking
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>
        </div>

        <div class="chat-input-container">
            <form class="chat-input-form" id="chat-form">
                <div class="input-actions">
                    <button type="button" class="action-button" id="image-upload-button" title="Upload Image">
                        <i class="fas fa-image"></i>
                    </button>
                    <button type="button" class="action-button" id="insights-button" title="Get Daily Insights">
                        <i class="fas fa-chart-line"></i>
                    </button>
                    <button type="button" class="action-button" id="memory-button" title="Memory Management">
                        <i class="fas fa-brain"></i>
                    </button>
                </div>
                <input 
                    type="text" 
                    class="chat-input" 
                    id="message-input" 
                    placeholder="Type your message to Jobo..."
                    autocomplete="off"
                >
                <input 
                    type="file" 
                    id="image-input" 
                    accept="image/*" 
                    style="display: none;"
                >
                <button type="submit" class="send-button" id="send-button">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
            </div>
        </div>
    </div>

    <!-- Enhanced Features Modals -->
    <div id="insights-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-chart-line"></i> AI Insights Dashboard</h3>
                <span class="close" onclick="closeModal('insights-modal')">&times;</span>
            </div>
            <div class="feature-grid">
                <div class="feature-card" onclick="getDailyInsights()">
                    <i class="fas fa-calendar-day"></i>
                    <h4>Daily Insights</h4>
                    <p>Get personalized insights about your interaction patterns and preferences</p>
                </div>
                <div class="feature-card" onclick="getPatternAnalysis()">
                    <i class="fas fa-brain"></i>
                    <h4>Pattern Analysis</h4>
                    <p>Deep analysis of your communication style and topic preferences</p>
                </div>
                <div class="feature-card" onclick="getIntelligenceStatus()">
                    <i class="fas fa-cogs"></i>
                    <h4>AI Status</h4>
                    <p>Check which AI capabilities are active and available</p>
                </div>
            </div>
            <div id="insights-display" class="insights-content" style="display: none;"></div>
        </div>
    </div>

    <div id="memory-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-brain"></i> Memory Management</h3>
                <span class="close" onclick="closeModal('memory-modal')">&times;</span>
            </div>
            <div class="feature-grid">
                <div class="feature-card" onclick="getMemoryStats()">
                    <i class="fas fa-chart-bar"></i>
                    <h4>Memory Statistics</h4>
                    <p>View your AI's memory usage and organization</p>
                </div>
                <div class="feature-card" onclick="getMemoryClusters()">
                    <i class="fas fa-project-diagram"></i>
                    <h4>Memory Clusters</h4>
                    <p>See how your conversations are organized thematically</p>
                </div>
                <div class="feature-card" onclick="optimizeMemory()">
                    <i class="fas fa-broom"></i>
                    <h4>Optimize Memory</h4>
                    <p>Consolidate and organize memories for better performance</p>
                </div>
            </div>
            <div id="memory-display" class="insights-content" style="display: none;"></div>
        </div>
    </div>

    <script>
        class JoboAuth {
            constructor() {
                this.token = localStorage.getItem('jobo-auth-token');
                this.user = null;
                
                // DOM elements
                this.authContainer = document.getElementById('auth-container');
                this.chatContainer = document.getElementById('chat-container');
                this.loginForm = document.getElementById('login-form');
                this.registerForm = document.getElementById('register-form');
                this.userInfo = document.getElementById('user-info');
                this.logoutButton = document.getElementById('logout-button');
                
                this.init();
            }
            
            init() {
                // Check if user is already logged in
                if (this.token) {
                    this.verifyToken();
                } else {
                    this.showAuth();
                }
                
                // Set up event listeners
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                // Form switching
                document.getElementById('show-register').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showRegister();
                });
                
                document.getElementById('show-login').addEventListener('click', (e) => {
                    e.preventDefault();
                    this.showLogin();
                });
                
                // Form submissions
                document.getElementById('login-form-element').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleLogin();
                });
                
                document.getElementById('register-form-element').addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.handleRegister();
                });
                
                // Logout
                this.logoutButton.addEventListener('click', () => {
                    this.handleLogout();
                });
            }
            
            showAuth() {
                this.authContainer.style.display = 'flex';
                this.chatContainer.style.display = 'none';
                this.userInfo.style.display = 'none';
                this.logoutButton.style.display = 'none';
            }
            
            showChat() {
                this.authContainer.style.display = 'none';
                this.chatContainer.style.display = 'flex';
                this.userInfo.style.display = 'block';
                this.logoutButton.style.display = 'block';
                
                // Initialize chat if not already done
                if (!this.chatInterface) {
                    this.chatInterface = new JoboChat(this.token);
                }
            }
            
            showLogin() {
                this.loginForm.style.display = 'block';
                this.registerForm.style.display = 'none';
                this.clearErrors();
            }
            
            showRegister() {
                this.loginForm.style.display = 'none';
                this.registerForm.style.display = 'block';
                this.clearErrors();
            }
            
            clearErrors() {
                document.getElementById('login-error').style.display = 'none';
                document.getElementById('register-error').style.display = 'none';
            }
            
            async verifyToken() {
                try {
                    const response = await fetch('/api/v1/auth/me', {
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        }
                    });
                    
                    if (response.ok) {
                        this.user = await response.json();
                        this.updateUserInfo();
                        this.showChat();
                    } else {
                        this.clearAuth();
                        this.showAuth();
                    }
                } catch (error) {
                    console.error('Token verification failed:', error);
                    this.clearAuth();
                    this.showAuth();
                }
            }
            
            async handleLogin() {
                const username = document.getElementById('login-username').value;
                const password = document.getElementById('login-password').value;
                const loginButton = document.getElementById('login-button');
                const errorDiv = document.getElementById('login-error');
                
                loginButton.disabled = true;
                loginButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Logging in...';
                
                try {
                    const response = await fetch('/api/v1/auth/login', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ username, password })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.token = data.access_token;
                        this.user = data.user;
                        localStorage.setItem('jobo-auth-token', this.token);
                        this.updateUserInfo();
                        this.showChat();
                    } else {
                        // Better error handling for different types of errors
                        let errorMessage = 'Login failed';
                        if (data.detail) {
                            if (typeof data.detail === 'string') {
                                errorMessage = data.detail;
                            } else if (Array.isArray(data.detail)) {
                                errorMessage = data.detail.map(err => err.msg || err.message || err).join(', ');
                            } else {
                                errorMessage = JSON.stringify(data.detail);
                            }
                        }
                        errorDiv.textContent = errorMessage;
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Login error:', error);
                    errorDiv.textContent = 'Connection error. Please try again.';
                    errorDiv.style.display = 'block';
                } finally {
                    loginButton.disabled = false;
                    loginButton.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
                }
            }
            
            async handleRegister() {
                const username = document.getElementById('register-username').value;
                const email = document.getElementById('register-email').value;
                const password = document.getElementById('register-password').value;
                const displayName = document.getElementById('register-display-name').value;
                const registerButton = document.getElementById('register-button');
                const errorDiv = document.getElementById('register-error');
                
                registerButton.disabled = true;
                registerButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Account...';
                
                try {
                    const response = await fetch('/api/v1/auth/register', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            username, 
                            email: email || null, 
                            password,
                            display_name: displayName || null
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        this.token = data.access_token;
                        this.user = data.user;
                        localStorage.setItem('jobo-auth-token', this.token);
                        this.updateUserInfo();
                        this.showChat();
                    } else {
                        // Better error handling for different types of errors
                        let errorMessage = 'Registration failed';
                        if (data.detail) {
                            if (typeof data.detail === 'string') {
                                errorMessage = data.detail;
                            } else if (Array.isArray(data.detail)) {
                                // Handle validation errors from Pydantic
                                errorMessage = data.detail.map(err => {
                                    if (err.msg) return err.msg;
                                    if (err.message) return err.message;
                                    return err;
                                }).join(', ');
                            } else {
                                errorMessage = JSON.stringify(data.detail);
                            }
                        }
                        
                        // Special handling for common errors
                        if (errorMessage.includes('Username already registered')) {
                            errorMessage = 'This username is already taken. Please try a different one.';
                        } else if (errorMessage.includes('Email already registered')) {
                            errorMessage = 'This email is already registered. Please use a different email or try logging in.';
                        }
                        
                        errorDiv.textContent = errorMessage;
                        errorDiv.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Registration error:', error);
                    errorDiv.textContent = 'Connection error. Please try again.';
                    errorDiv.style.display = 'block';
                } finally {
                    registerButton.disabled = false;
                    registerButton.innerHTML = '<i class="fas fa-user-plus"></i> Create Account';
                }
            }
            
            async handleLogout() {
                try {
                    await fetch('/api/v1/auth/logout', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${this.token}`
                        }
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                }
                
                this.clearAuth();
                this.showAuth();
            }
            
            clearAuth() {
                this.token = null;
                this.user = null;
                localStorage.removeItem('jobo-auth-token');
            }
            
            updateUserInfo() {
                if (this.user) {
                    document.getElementById('current-username').textContent = this.user.username;
                    
                    // Update welcome message
                    const welcomeMessage = document.getElementById('welcome-message');
                    if (welcomeMessage) {
                        welcomeMessage.innerHTML = `
                            <h2>ðŸ‘‹ Welcome back, ${this.user.display_name || this.user.username}!</h2>
                            <p>I'm your personalized AI assistant. I remember our previous conversations and adapt to your communication style.</p>
                            <p>What would you like to talk about today?</p>
                        `;
                    }
                }
            }
        }
        
        class JoboChat {
            constructor(token) {
                this.token = token;
                this.messagesContainer = document.getElementById('chat-messages');
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.chatForm = document.getElementById('chat-form');
                this.typingIndicator = document.getElementById('typing-indicator');
                
                this.init();
                this.setupMobileKeyboardHandling();
            }

            init() {
                this.chatForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    this.sendMessage();
                });

                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Remove welcome message on first interaction
                this.messageInput.addEventListener('focus', () => {
                    const welcomeMessage = document.querySelector('.welcome-message');
                    if (welcomeMessage) {
                        welcomeMessage.style.display = 'none';
                    }
                }, { once: true });
            }

            setupMobileKeyboardHandling() {
                // Handle mobile keyboard appearance
                let initialViewportHeight = window.innerHeight;
                
                // Store initial viewport height
                const setInitialHeight = () => {
                    initialViewportHeight = window.innerHeight;
                };
                
                // Handle viewport changes (keyboard appearance/disappearance)
                const handleViewportChange = () => {
                    const currentHeight = window.innerHeight;
                    const heightDifference = initialViewportHeight - currentHeight;
                    
                    // If height decreased significantly, keyboard is likely open
                    if (heightDifference > 150) {
                        document.body.classList.add('keyboard-open');
                        // Ensure input stays in view
                        setTimeout(() => {
                            this.messageInput.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                        }, 100);
                    } else {
                        document.body.classList.remove('keyboard-open');
                    }
                };

                // Listen for viewport changes
                window.addEventListener('resize', handleViewportChange);
                window.addEventListener('orientationchange', () => {
                    setTimeout(setInitialHeight, 500);
                });

                // Handle input focus/blur for mobile
                this.messageInput.addEventListener('focus', () => {
                    // Small delay to ensure keyboard is shown
                    setTimeout(() => {
                        this.messageInput.scrollIntoView({ 
                            behavior: 'smooth', 
                            block: 'center' 
                        });
                    }, 300);
                });

                this.messageInput.addEventListener('blur', () => {
                    // Reset any mobile-specific styling when input loses focus
                    document.body.classList.remove('keyboard-open');
                });

                // Prevent zoom on double tap for the input
                let lastTouchEnd = 0;
                this.messageInput.addEventListener('touchend', (e) => {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        e.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);

                // Set initial height
                setInitialHeight();
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message) return;

                // Add user message to chat
                this.addMessage(message, 'user');
                this.messageInput.value = '';
                this.setLoading(true);

                try {
                    let responseText;
                    
                    // Check if there's an image to analyze
                    if (window.currentImageFile) {
                        responseText = await window.sendImageAnalysis(message);
                    } else {
                        // Regular text chat
                        const response = await fetch('/api/v1/chat', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${this.token}`
                            },
                            body: JSON.stringify({
                                message: message
                            })
                        });

                        if (!response.ok) {
                            if (response.status === 401) {
                                // Token expired, redirect to login
                                window.location.reload();
                                return;
                            }
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }

                        const data = await response.json();
                        responseText = data.response;
                    }
                    
                    this.addMessage(responseText, 'assistant');
                    
                } catch (error) {
                    console.error('Error:', error);
                    this.addMessage(
                        "I'm sorry, I'm having trouble connecting right now. Please try again later.", 
                        'assistant'
                    );
                } finally {
                    this.setLoading(false);
                }
            }

            addMessage(content, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const avatar = document.createElement('div');
                avatar.className = 'message-avatar';
                avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = content;
                
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(messageContent);
                
                // Remove welcome message if it exists
                const welcomeMessage = document.querySelector('.welcome-message');
                if (welcomeMessage) {
                    welcomeMessage.remove();
                }
                
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
            }

            setLoading(loading) {
                this.sendButton.disabled = loading;
                this.messageInput.disabled = loading;
                
                if (loading) {
                    this.typingIndicator.style.display = 'flex';
                    this.scrollToBottom();
                } else {
                    this.typingIndicator.style.display = 'none';
                }
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
                }, 100);
            }
        }

        // Enhanced Features JavaScript
        window.currentImageFile = null;
        window.auth = null;

        // Enhanced features functionality
        function setupEnhancedFeatures(authInstance) {
            window.auth = authInstance;
            
            // Image upload button
            document.getElementById('image-upload-button').addEventListener('click', () => {
                document.getElementById('image-input').click();
            });
            
            // Image input change
            document.getElementById('image-input').addEventListener('change', handleImageUpload);
            
            // Insights button
            document.getElementById('insights-button').addEventListener('click', () => {
                openModal('insights-modal');
            });
            
            // Memory button
            document.getElementById('memory-button').addEventListener('click', () => {
                openModal('memory-modal');
            });
        }

        function handleImageUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            if (file.size > 10 * 1024 * 1024) { // 10MB limit
                alert('Image is too large. Please choose an image under 10MB.');
                return;
            }

            window.currentImageFile = file;
            
            // Show image preview
            const reader = new FileReader();
            reader.onload = (e) => {
                showImagePreview(e.target.result, file.name);
            };
            reader.readAsDataURL(file);
        }

        function showImagePreview(imageSrc, fileName) {
            // Remove existing preview
            const existingPreview = document.querySelector('.image-preview');
            if (existingPreview) {
                existingPreview.remove();
            }

            // Create preview
            const preview = document.createElement('div');
            preview.className = 'image-preview';
            preview.innerHTML = `
                <img src="${imageSrc}" alt="Preview">
                <p><strong>${fileName}</strong></p>
                <p>Type your question about this image and click send!</p>
                <button class="remove-image" onclick="removeImagePreview()">Remove Image</button>
            `;

            // Insert before input container
            const inputContainer = document.querySelector('.chat-input-container');
            inputContainer.parentNode.insertBefore(preview, inputContainer);

            // Update input placeholder
            const messageInput = document.getElementById('message-input');
            messageInput.placeholder = 'Ask me about this image...';
        }

        function removeImagePreview() {
            const preview = document.querySelector('.image-preview');
            if (preview) {
                preview.remove();
            }
            window.currentImageFile = null;
            document.getElementById('message-input').placeholder = 'Type your message to Jobo...';
            document.getElementById('image-input').value = '';
        }

        window.sendImageAnalysis = async function(message) {
            if (!window.currentImageFile || !window.auth.token) return false;

            const formData = new FormData();
            formData.append('file', window.currentImageFile);
            formData.append('prompt', message);

            try {
                const response = await fetch('/api/v1/enhanced/vision/analyze', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${window.auth.token}`
                    },
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                
                // Remove image preview
                removeImagePreview();
                
                // Add analysis to chat
                const analysisMessage = `**Image Analysis Results:**

${data.analysis.description}

${data.analysis.insights ? '**Key Insights:**\n' + data.analysis.insights.map(insight => `â€¢ ${insight}`).join('\n') : ''}

${data.analysis.suggestions ? '\n**Suggestions:**\n' + data.analysis.suggestions.map(suggestion => `â€¢ ${suggestion}`).join('\n') : ''}`;

                return analysisMessage;
                
            } catch (error) {
                console.error('Image analysis error:', error);
                removeImagePreview();
                return "I'm sorry, I couldn't analyze that image. Please try again.";
            }
        }

        // Modal functions
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Enhanced features API calls
        async function getDailyInsights() {
            if (!window.auth.token) return;

            try {
                const response = await fetch('/api/v1/enhanced/insights/daily', {
                    headers: { 'Authorization': `Bearer ${window.auth.token}` }
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                displayInsights(data.insights);
            } catch (error) {
                console.error('Error getting daily insights:', error);
                displayError('insights-display', 'Failed to load daily insights');
            }
        }

        async function getPatternAnalysis() {
            if (!window.auth.token) return;

            try {
                const response = await fetch('/api/v1/enhanced/insights/patterns', {
                    headers: { 'Authorization': `Bearer ${window.auth.token}` }
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                displayPatterns(data.patterns);
            } catch (error) {
                console.error('Error getting pattern analysis:', error);
                displayError('insights-display', 'Failed to load pattern analysis');
            }
        }

        async function getIntelligenceStatus() {
            if (!window.auth.token) return;

            try {
                const response = await fetch('/api/v1/enhanced/intelligence/status', {
                    headers: { 'Authorization': `Bearer ${window.auth.token}` }
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                displayIntelligenceStatus(data.status);
            } catch (error) {
                console.error('Error getting intelligence status:', error);
                displayError('insights-display', 'Failed to load intelligence status');
            }
        }

        async function getMemoryStats() {
            if (!window.auth.token) return;

            try {
                const response = await fetch('/api/v1/enhanced/memory/stats', {
                    headers: { 'Authorization': `Bearer ${window.auth.token}` }
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                displayMemoryStats(data.stats);
            } catch (error) {
                console.error('Error getting memory stats:', error);
                displayError('memory-display', 'Failed to load memory statistics');
            }
        }

        async function getMemoryClusters() {
            if (!window.auth.token) return;

            try {
                const response = await fetch('/api/v1/enhanced/memory/clusters', {
                    headers: { 'Authorization': `Bearer ${window.auth.token}` }
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                displayMemoryClusters(data.clusters);
            } catch (error) {
                console.error('Error getting memory clusters:', error);
                displayError('memory-display', 'Failed to load memory clusters');
            }
        }

        async function optimizeMemory() {
            if (!window.auth.token) return;

            try {
                const response = await fetch('/api/v1/enhanced/memory/consolidate', {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${window.auth.token}` }
                });

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const data = await response.json();
                displayMemoryOptimization(data);
            } catch (error) {
                console.error('Error optimizing memory:', error);
                displayError('memory-display', 'Failed to start memory optimization');
            }
        }

        // Display functions
        function displayInsights(insights) {
            const display = document.getElementById('insights-display');
            display.style.display = 'block';
            display.innerHTML = `
                <h4><i class="fas fa-calendar-day"></i> Daily Insights for ${insights.date}</h4>
                
                <div class="insight-section">
                    <h4>ðŸ“Š Activity Summary</h4>
                    <div class="insight-item">
                        <strong>Total Interactions:</strong> ${insights.activity_summary?.total_interactions || 0}<br>
                        <strong>Average Daily:</strong> ${insights.activity_summary?.avg_daily_interactions || 0}<br>
                        <strong>Most Active Hour:</strong> ${insights.activity_summary?.most_active_hour || 'Not enough data'}
                    </div>
                </div>

                <div class="insight-section">
                    <h4>ðŸŽ¯ Topic Trends</h4>
                    <div class="insight-item">
                        <strong>Top Topics:</strong> ${insights.topic_trends?.top_topics?.join(', ') || 'Discovering your interests'}<br>
                        <strong>Focus Areas:</strong> ${insights.topic_trends?.focus_areas?.join(', ') || 'General conversation'}
                    </div>
                </div>

                <div class="engagement-score">
                    Engagement Score: ${insights.engagement_score || '0.0'}
                </div>

                ${insights.suggestions?.length ? `
                <div class="insight-section">
                    <h4>ðŸ’¡ Personalized Suggestions</h4>
                    ${insights.suggestions.map(suggestion => `
                        <div class="suggestion-item">
                            <strong>${suggestion.title}</strong><br>
                            ${suggestion.description}
                        </div>
                    `).join('')}
                </div>
                ` : ''}
            `;
        }

        function displayPatterns(patterns) {
            const display = document.getElementById('insights-display');
            display.style.display = 'block';
            display.innerHTML = `
                <h4><i class="fas fa-brain"></i> Pattern Analysis (${patterns.analysis_period})</h4>
                
                <div class="insight-section">
                    <h4>ðŸ—£ï¸ Communication Style</h4>
                    <div class="insight-item">
                        <strong>Verbosity:</strong> ${patterns.communication_insights?.verbosity || 'Unknown'}<br>
                        <strong>Inquiry Style:</strong> ${patterns.communication_insights?.inquiry_style || 'Unknown'}<br>
                        <strong>Average Message Length:</strong> ${patterns.communication_insights?.avg_message_length || 0} characters
                    </div>
                </div>

                <div class="insight-section">
                    <h4>â° Activity Patterns</h4>
                    <div class="insight-item">
                        <strong>Peak Hours:</strong> ${patterns.activity_patterns?.peak_hours?.join(', ') || 'Not enough data'}<br>
                        <strong>Consistency Score:</strong> ${patterns.activity_patterns?.consistency_score?.toFixed(2) || '0.00'}
                    </div>
                </div>

                <div class="engagement-score">
                    Overall Engagement: ${patterns.engagement_score || '0.0'}
                </div>
            `;
        }

        function displayIntelligenceStatus(status) {
            const display = document.getElementById('insights-display');
            display.style.display = 'block';
            
            const capabilities = status.capabilities || {};
            display.innerHTML = `
                <h4><i class="fas fa-cogs"></i> AI Intelligence Status</h4>
                
                <div class="insight-section">
                    <h4>ðŸ¤– Active Capabilities</h4>
                    ${Object.entries(capabilities).map(([key, value]) => `
                        <div class="insight-item">
                            <strong>${key.replace(/_/g, ' ').toUpperCase()}:</strong> 
                            <span style="color: ${value ? '#10b981' : '#ef4444'}">
                                ${value ? 'âœ… Active' : 'âŒ Inactive'}
                            </span>
                        </div>
                    `).join('')}
                </div>

                <div class="insight-section">
                    <h4>ðŸ“Š Memory Status</h4>
                    <div class="insight-item">
                        <strong>Semantic Memory:</strong> ${status.memory_status?.semantic_memory_count || 0} memories<br>
                        <strong>Short-term Memory:</strong> ${status.memory_status?.short_term_memory_count || 0} messages<br>
                        <strong>System Health:</strong> ${status.memory_status?.memory_system_health || 'Unknown'}
                    </div>
                </div>

                <div class="engagement-score">
                    Intelligence Level: ${status.intelligence_level || 'Unknown'}
                </div>
            `;
        }

        function displayMemoryStats(stats) {
            const display = document.getElementById('memory-display');
            display.style.display = 'block';
            display.innerHTML = `
                <h4><i class="fas fa-chart-bar"></i> Memory Statistics</h4>
                
                <div class="insight-section">
                    <h4>ðŸ’¾ Storage Overview</h4>
                    <div class="insight-item">
                        <strong>Semantic Memories:</strong> ${stats.semantic_memory_count || 0}<br>
                        <strong>Short-term Messages:</strong> ${stats.short_term_memory_count || 0}<br>
                        <strong>System Health:</strong> ${stats.memory_system_health || 'Unknown'}
                    </div>
                </div>

                ${stats.memory_organization ? `
                <div class="insight-section">
                    <h4>ðŸ§  Memory Organization</h4>
                    <div class="insight-item">
                        <strong>Identified Clusters:</strong> ${stats.memory_organization.identified_clusters}<br>
                        <strong>Organization Quality:</strong> ${stats.memory_organization.organization_quality}<br>
                        <strong>Average Cluster Size:</strong> ${stats.memory_organization.average_cluster_size?.toFixed(1) || '0'}
                    </div>
                </div>
                ` : ''}
            `;
        }

        function displayMemoryClusters(clusters) {
            const display = document.getElementById('memory-display');
            display.style.display = 'block';
            display.innerHTML = `
                <h4><i class="fas fa-project-diagram"></i> Memory Clusters</h4>
                
                ${clusters.length ? clusters.map(cluster => `
                    <div class="insight-section">
                        <h4>ðŸŽ¯ ${cluster.theme}</h4>
                        <div class="insight-item">
                            <strong>Description:</strong> ${cluster.description}<br>
                            <strong>Memory Count:</strong> ${cluster.memory_count}<br>
                            <strong>Strength:</strong> ${cluster.strength}
                        </div>
                    </div>
                `).join('') : '<div class="insight-item">No memory clusters found yet. Keep chatting to build organized memories!</div>'}
            `;
        }

        function displayMemoryOptimization(result) {
            const display = document.getElementById('memory-display');
            display.style.display = 'block';
            display.innerHTML = `
                <h4><i class="fas fa-broom"></i> Memory Optimization</h4>
                
                <div class="insight-item">
                    <strong>Status:</strong> ${result.message}<br>
                    ${result.note ? `<em>${result.note}</em>` : ''}
                </div>
            `;
        }

        function displayError(displayId, message) {
            const display = document.getElementById(displayId);
            display.style.display = 'block';
            display.innerHTML = `
                <div class="insight-item" style="border-left-color: #dc2626; background: #fee2e2;">
                    <strong>Error:</strong> ${message}
                </div>
            `;
        }

        // Close modals when clicking outside
        window.addEventListener('click', (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        });

        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            const authInstance = new JoboAuth();
            
            // Set up enhanced features after a short delay to ensure auth is ready
            setTimeout(() => {
                setupEnhancedFeatures(authInstance);
            }, 500);
        });
    </script>
</body>
</html> 